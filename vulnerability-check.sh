#!/bin/bash

PREFETCH=$(clojure -Stree -Sdeps '{:deps {lein-nvd/lein-nvd {:mvn/version "1.4.1"}}}')
echo "Preftech complete"

VULNS=$(clojure -Sdeps '{:deps {lein-nvd/lein-nvd {:mvn/version "1.4.1"}}}' -M -m nvd.task.check 2> /dev/null | grep CVE)
echo "Finished scanning for vulnerabilities"

VULNERABLE_JARS=$(clojure -Sdeps '{:deps {lein-nvd/lein-nvd {:mvn/version "1.4.1"}}}' -M -m nvd.task.check 2> /dev/null | grep CVE | awk '{print $2}' | sed -e 's/-[[:digit:]]*\.[[:digit:]]*\.[[:digit:]]*.jar.*//' -e 's/.jar//')
echo "Locating vulnerable jars"

OUR_DEPS=$(clojure -Stree | sed -e 's/[[:blank:]]/-/g')
echo "Loading project dependencies"


CVE_FOUND=0

for JAR in $VULNERABLE_JARS
do
	grep -q $JAR <<< "$OUR_DEPS"
	if [ $? -eq 0 ]
	then
        CVES=$(grep $JAR <<< "$VULNS" | awk 'BEGIN { FS="|"}{print $3}')
        echo "***"
		echo "$JAR FOUND in project dependencies."
        echo "Known CVEs: $CVES"
		CVE_FOUND=1
	fi
done

if [ ${CVE_FOUND} -eq 0 ]
then
	echo "No CVEs from project dependencies."
else
	echo "CVEs found in project dependencies. Check above"
    exit 1
fi
